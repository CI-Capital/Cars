<!DOCTYPE html><html><head>
<script>
let isAdmin = false;
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CI Capital Car Auction</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto">

    <h1 class="text-3xl font-bold text-center mb-8">
        CI Capital Car Auction
    </h1>

    <!-- CARS DISPLAY FIRST -->
    <div id="cars" class="grid md:grid-cols-2 gap-6 mb-16"></div>

    <!-- DISCREET ADMIN ACCESS -->
    <div class="text-center mt-10">
        <button onclick="showAdminLogin()"
            class="text-sm text-gray-500 hover:text-gray-800 underline">
            Admin Access
        </button>
    </div>

    <!-- ADMIN LOGIN (HIDDEN INITIALLY) -->
    <div id="adminLogin" class="hidden bg-white p-6 rounded-xl shadow mt-6 max-w-md mx-auto">
        <h2 class="text-lg font-semibold mb-4 text-center">Admin Login</h2>

        <input id="adminCode" type="password"
            placeholder="Enter Admin Code"
            class="border p-2 rounded w-full mb-3">

        <button onclick="unlockAdmin()"
            class="bg-blue-600 text-white px-4 py-2 rounded w-full">
            Unlock Admin
        </button>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden bg-white p-6 rounded-xl shadow mt-8">
        <h2 class="text-lg font-semibold mb-4">Upload New Car</h2>

        <input id="carTitle" placeholder="Car Title"
            class="border p-2 rounded w-full mb-2">

        <input id="startingPrice" type="number"
            placeholder="Starting Price (EGP)"
            class="border p-2 rounded w-full mb-2">

        <textarea id="description"
            placeholder="Description"
            class="border p-2 rounded w-full mb-2"></textarea>

        <textarea id="imageUrls"
    placeholder="Enter image URLs separated by commas"
    class="border p-2 rounded w-full mb-2"></textarea>

        <button onclick="uploadCar()"
            class="bg-green-600 text-white px-4 py-2 rounded w-full">
            Upload Car
        </button>

        <!-- ADMIN BID VIEW -->
        <div class="mt-10">
            <h2 class="text-lg font-semibold mb-4">Submitted Bids</h2>
            <div id="adminBids"></div>
        </div>
    </div>

</div>
<script type="module">

/* FIREBASE IMPORTS */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    updateDoc,
    deleteDoc,
    doc,
    getDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCMXAlQ9FVS76OvXZZdAdllp_h1EhWx_Pw",
  authDomain: "ci-capital-cars.firebaseapp.com",
  projectId: "ci-capital-cars",
  storageBucket: "ci-capital-cars.firebasestorage.app",
  messagingSenderId: "191123263324",
  appId: "1:191123263324:web:97426e890e511eba3e7b99"
};

/* INITIALIZE FIREBASE */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ADMIN PASSWORD */
const ADMIN_PASSWORD = "ADMIN123";

/* ADMIN UNLOCK */
window.unlockAdmin = function() {
    const entered = document.getElementById("adminCode").value;

    if (entered === ADMIN_PASSWORD) {
        isAdmin = true; // 
        document.getElementById("adminPanel").classList.remove("hidden");
        renderCars(); // 
    } else {
        alert("Incorrect admin code");
    }
};

window.deleteBid = async function(carId, bidIndex) {

    const confirmDelete = confirm("Delete this bid?");
    if (!confirmDelete) return;

    const carRef = doc(db, "cars", carId);
    const snap = await getDoc(carRef);

    if (!snap.exists()) return;

    const data = snap.data();

    // Sort bids like admin view
    const sortedBids = data.bids
        .slice()
        .sort((a, b) => b.amount - a.amount);

    const bidToDelete = sortedBids[bidIndex];

    const updatedBids = data.bids.filter(b =>
        !(b.name === bidToDelete.name &&
          b.emp === bidToDelete.emp &&
          b.amount === bidToDelete.amount &&
          b.time === bidToDelete.time)
    );

    const newHighest = updatedBids.length > 0
        ? Math.max(...updatedBids.map(b => b.amount))
        : data.startingPrice;

    await updateDoc(carRef, {
        bids: updatedBids,
        highestBid: newHighest
    });

    alert("Bid deleted");
};
    
window.showAdminLogin = function() {
    document.getElementById("adminLogin").classList.toggle("hidden");
};
    
/* UPLOAD CAR */
window.uploadCar = async function() {

    const title = document.getElementById("carTitle").value;
    const price = document.getElementById("startingPrice").value;
    const desc = document.getElementById("description").value;
   const imageInput = document.getElementById("imageUrls").value;

const images = imageInput
    .split(",")
    .map(url => url.trim())
    .filter(url => url.length > 0);

    if (!title || !price || !desc || images.length === 0) {
        alert("Fill all fields");
        return;
    }

 await addDoc(collection(db, "cars"), {
    title,
    description: desc,
    images: images,
    startingPrice: Number(price),
    highestBid: Number(price),
    bids: [],
    isLive: false
});

    alert("Car uploaded successfully");

    document.getElementById("imageUrls").value = "";
    document.getElementById("startingPrice").value = "";
    document.getElementById("description").value = "";
    document.getElementById("imageUrl").value = "";
};

window.deleteCar = async function(id) {

    const confirmDelete = confirm("Are you sure you want to delete this car?");

    if (!confirmDelete) return;

    try {
        await deleteDoc(doc(db, "cars", id));
        alert("Car deleted successfully");
    } catch (error) {
        alert("Error deleting car");
        console.error(error);
    }
};

    window.editCar = async function(id) {

    const carRef = doc(db, "cars", id);
    const snap = await getDoc(carRef);

    if (!snap.exists()) {
        alert("Car not found");
        return;
    }

    const car = snap.data();

    // Fill admin form with existing data
    document.getElementById("carTitle").value = car.title;
    document.getElementById("description").value = car.description;
    document.getElementById("startingPrice").value = car.startingPrice;
    document.getElementById("imageUrls").value = car.images.join(", ");

    // Change upload button behavior to update instead
    const uploadBtn = document.querySelector("#adminPanel button");

    uploadBtn.textContent = "Update Car";
    uploadBtn.onclick = async function() {

        await updateDoc(carRef, {
            title: document.getElementById("carTitle").value,
            description: document.getElementById("description").value,
            startingPrice: Number(document.getElementById("startingPrice").value),
            images: document.getElementById("imageUrls").value
                .split(",")
                .map(url => url.trim())
                .filter(url => url.length > 0)
        });

        alert("Car updated successfully");

        uploadBtn.textContent = "Upload Car";
        uploadBtn.onclick = uploadCar;

        renderCars();
    };
};

/* PLACE BID */
import { runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

window.placeBid = async function(id) {

    const name = document.getElementById(`name-${id}`).value;
    const emp = document.getElementById(`emp-${id}`).value;
    const bidAmount = Number(document.getElementById(`bid-${id}`).value);

    if (!name.trim() || !emp.trim() || isNaN(bidAmount) || bidAmount <= 0) {
        alert("Fill all fields");
        return;
    }

    const carRef = doc(db, "cars", id);

    try {
        await runTransaction(db, async (transaction) => {
            const snap = await transaction.get(carRef);
            const data = snap.data();

            if (bidAmount <= data.highestBid) {
                throw "Bid too low";
            }

            const updatedBids = [
                ...data.bids,
                {
                    name,
                    emp,
                    amount: bidAmount,
                    time: new Date().toLocaleString()
                }
            ];

            transaction.update(carRef, {
                highestBid: bidAmount,
                bids: updatedBids
            });
        });

        alert("Bid submitted successfully");

    } catch (error) {
        alert("Bid must be higher than current highest bid.");
    }
};

/* REAL-TIME LISTENER */
let carsData = [];

onSnapshot(collection(db, "cars"), (snapshot) => {

    carsData = [];

    snapshot.forEach((docSnap) => {
        carsData.push({
            id: docSnap.id,
            ...docSnap.data()
        });
    });

    renderCars(); // 
});
    function startCarousel(id, images) {

    if (!images || images.length <= 1) return;

    let index = 0;

    setInterval(() => {

        index = (index + 1) % images.length;

        const imgElement = document.getElementById(`carousel-${id}`);
        if (imgElement) {
            imgElement.src = images[index];
        }

    }, 3000); // 3 seconds
}
function renderCars() {

    const container = document.getElementById("cars");
    const adminContainer = document.getElementById("adminBids");

    container.innerHTML = "";
    if (adminContainer) adminContainer.innerHTML = "";

    carsData.forEach((car) => {

        const id = car.id;

        container.innerHTML += `
<div class="bg-white p-4 rounded-xl shadow relative">

    ${isAdmin ? `
        <div class="absolute top-2 right-2 flex gap-2">
            <button onclick="editCar('${id}')"
                class="bg-yellow-500 text-white px-2 py-1 text-xs rounded">
                Edit
            </button>
            <button onclick="deleteCar('${id}')"
                class="bg-red-600 text-white px-2 py-1 text-xs rounded">
                Delete
            </button>
        </div>
    ` : ""}
    
    <div class="relative w-full h-56 mb-4 overflow-hidden rounded">
    <img id="carousel-${id}" 
        src="${car.images && car.images.length ? car.images[0] : ''}" 
        class="w-full h-56 object-cover rounded">
</div>

    <h3 class="text-xl font-bold">${car.title}</h3>
    <p class="text-gray-600 mb-2">${car.description}</p>

    <p class="text-green-600 font-semibold mb-4">
        Highest Bid: EGP ${(car.highestBid || 0).toLocaleString()}
    </p>

    <div class="border-t pt-4 mt-4">

        <input id="name-${id}" 
            placeholder="Your Name (Required)"
            class="border p-2 rounded w-full mb-2">

        <input id="emp-${id}" 
            placeholder="Employee ID (Required)"
            class="border p-2 rounded w-full mb-2">

        <input id="bid-${id}" 
            type="number"
            placeholder="Your Bid (Must exceed highest bid)"
            class="border p-2 rounded w-full mb-2">

        <button onclick="placeBid('${id}')"
            class="bg-blue-600 text-white px-4 py-2 rounded w-full">
            Place Bid
        </button>

    </div>

</div>
`;

startCarousel(id, car.images);

        // ✅ ✅ ADMIN BID LIST
       if (isAdmin && car.bids && car.bids.length > 0) {

    adminContainer.innerHTML += `
<div class="border rounded p-4 mb-4 bg-gray-50">
    <h3 class="font-semibold mb-2">${car.title}</h3>
    ${car.bids
        .slice()
        .sort((a, b) => b.amount - a.amount)
        .map((bid, index) => `
    <div class="border-b py-2 text-sm flex justify-between items-start">
        <div>
            <div><strong>Name:</strong> ${bid.name}</div>
            <div><strong>Employee ID:</strong> ${bid.emp}</div>
            <div><strong>Bid:</strong> EGP ${bid.amount.toLocaleString()}</div>
            <div class="text-gray-500">${bid.time}</div>
        </div>

        <button onclick="deleteBid('${car.id}', ${index})"
            class="bg-red-500 text-white px-2 py-1 text-xs rounded ml-4">
            Delete
        </button>
    </div>
`)
        .join("")}
</div>
`;
    }
    });
}

</script>



</body></html>
